<!DOCTYPE html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://fyhhub.github.io/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html"><meta property="og:title" content="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°"><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-02-02T09:52:47.000Z"><meta property="og:locale" content="en-US"><meta property="article:modified_time" content="2023-02-02T09:52:47.000Z"><script>
    var hm1
    (function() {
      hm1 = document.createElement("script");
      hm1.src = "https://www.googletagmanager.com/gtag/js?id=G-BWGLYWG03M";
      var s1 = document.getElementsByTagName("script")[0]; 
      s1.parentNode.insertBefore(hm1, s1);
    })();
    hm1.onload = function() {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BWGLYWG03M');
    }
  </script><title>Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç° | </title><meta name="description" content="">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.39a79e26.css">
    <link rel="modulepreload" href="/assets/app.c4c36fb7.js"><link rel="modulepreload" href="/assets/Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°.html.aff1c57c.js"><link rel="modulepreload" href="/assets/plugin-vueexport-helper.2444895f.js"><link rel="modulepreload" href="/assets/Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°.html.05ff508d.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt><!----><!----></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="é¦–é¡µ"><span class="icon iconfont icon-home"></span>é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å‰ç«¯å¼€å‘"><span class="title"><span class="icon iconfont icon-html"></span>å‰ç«¯å¼€å‘</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å‰ç«¯åŸºç¡€</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend-basic/css" class="nav-link" aria-label="CSS"><span class="icon iconfont icon-css"></span>CSS<!----></a></li><li class="dropdown-subitem"><a href="/frontend-basic/html" class="nav-link" aria-label="HTML"><span class="icon iconfont icon-html"></span>HTML<!----></a></li><li class="dropdown-subitem"><a href="/frontend-basic/js" class="nav-link" aria-label="JS"><span class="icon iconfont icon-javascript"></span>JS<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å‰ç«¯è¿›é˜¶</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend-advanced/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/" class="nav-link" aria-label="æµè§ˆå™¨åŸç†"><span class="icon iconfont icon-chrome"></span>æµè§ˆå™¨åŸç†<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/%E5%BE%AE%E5%89%8D%E7%AB%AF/" class="nav-link" aria-label="å¾®å‰ç«¯"><span class="icon iconfont icon-workingDirectory"></span>å¾®å‰ç«¯<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/Javascript/" class="nav-link" aria-label="JavaScript"><span class="icon iconfont icon-javascript"></span>JavaScript<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/Node/" class="nav-link" aria-label="Node"><span class="icon iconfont icon-nodeJS"></span>Node<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/React/" class="nav-link" aria-label="React"><span class="icon iconfont icon-react"></span>React<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/Typescript/" class="nav-link" aria-label="Typescript"><span class="icon iconfont icon-typescript"></span>Typescript<!----></a></li><li class="dropdown-subitem"><a href="/frontend-advanced/Vue/" class="nav-link" aria-label="Vue"><span class="icon iconfont icon-vue"></span>Vue<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å‰ç«¯å·¥ç¨‹åŒ–</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend-engineering/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5" class="nav-link" aria-label="å‰ç«¯å·¥ç¨‹å®è·µ"><span class="icon iconfont icon-app"></span>å‰ç«¯å·¥ç¨‹å®è·µ<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" class="nav-link" aria-label="å‰ç«¯æ€§èƒ½ä¼˜åŒ–"><span class="icon iconfont icon-align"></span>å‰ç«¯æ€§èƒ½ä¼˜åŒ–<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/Babel" class="nav-link" aria-label="Babel"><img class="icon" src="/babel.svg">Babel<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/ESLint" class="nav-link" aria-label="ESLint"><img class="icon" src="/eslint.svg">ESLint<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/rollup" class="nav-link" aria-label="rollup"><img class="icon" src="/rollup.svg">rollup<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/Vite" class="nav-link" aria-label="Vite"><img class="icon" src="/vite.svg">Vite<!----></a></li><li class="dropdown-subitem"><a href="/frontend-engineering/webpack" class="nav-link" aria-label="webpack"><img class="icon" src="/webpack.svg">webpack<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/tools/" class="nav-link" aria-label="å¼€å‘å·¥å…·"><span class="icon iconfont icon-tool"></span>å¼€å‘å·¥å…·<!----></a></div><div class="nav-item hide-in-mobile"><a href="/algorithm/" class="nav-link" aria-label="ç®—æ³•"><span class="icon iconfont icon-state"></span>ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><a href="/basic/" class="nav-link" aria-label="è®¡ç®—æœºåŸºç¡€"><span class="icon iconfont icon-code"></span>è®¡ç®—æœºåŸºç¡€<!----></a></div><div class="nav-item hide-in-mobile"><a href="/informal/" class="nav-link active" aria-label="éšç¬”"><span class="icon iconfont icon-write"></span>éšç¬”<!----></a></div><div class="nav-item hide-in-mobile"><a href="/interview/" class="nav-link" aria-label="é¢ç»"><span class="icon iconfont icon-strong"></span>é¢ç»<!----></a></div><div class="nav-item hide-in-mobile"><a href="/c/" class="nav-link" aria-label="C/C++"><span class="icon iconfont icon-copyright"></span>C/C++<!----></a></div><div class="nav-item hide-in-mobile"><a href="/comment/" class="nav-link" aria-label="ç•™è¨€æ¿"><span class="icon iconfont icon-comment"></span>ç•™è¨€æ¿<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/fyhhub/fyhhub.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å…¶ä»–</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å¼€å‘è®°å½•</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">è¯»ä¹¦ç¬”è®°</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Vuejsè®¾è®¡ä¸å®ç°</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89%E7%AC%AC%201%20%E7%AB%A0-%E6%9D%83%E8%A1%A1%E7%9A%84%E8%89%BA%E6%9C%AF.html" class="nav-link sidebar-link sidebar-page" aria-label="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆä¸€ï¼‰ç¬¬ 1 ç« -æƒè¡¡çš„è‰ºæœ¯"><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆä¸€ï¼‰ç¬¬ 1 ç« -æƒè¡¡çš„è‰ºæœ¯<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%E7%AC%AC3%E7%AB%A0-Vue.js%203%20%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF.html" class="nav-link sidebar-link sidebar-page" aria-label="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆä¸‰ï¼‰ç¬¬3ç« -Vue.js 3 çš„è®¾è®¡æ€è·¯"><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆä¸‰ï¼‰ç¬¬3ç« -Vue.js 3 çš„è®¾è®¡æ€è·¯<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E7%AC%AC%202%20%E7%AB%A0-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%A0%B8%E5%BF%83%E8%A6%81%E7%B4%A0.html" class="nav-link sidebar-link sidebar-page" aria-label="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆäºŒï¼‰ç¬¬ 2 ç« -æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒè¦ç´ "><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆäºŒï¼‰ç¬¬ 2 ç« -æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒè¦ç´ <!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°"><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-1-å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°"><!---->4.1 å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-2-å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°"><!---->4.2 å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-3-è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ"><!---->4.3 è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-4-åˆ†æ”¯åˆ‡æ¢ä¸-cleanup" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4 åˆ†æ”¯åˆ‡æ¢ä¸ cleanup"><!---->4.4 åˆ†æ”¯åˆ‡æ¢ä¸ cleanup<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-5-åµŒå¥—çš„effect-ä¸-effectæ ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.5 åµŒå¥—çš„effect ä¸ effectæ ˆ"><!---->4.5 åµŒå¥—çš„effect ä¸ effectæ ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-6-é¿å…æ— é™é€’å½’å¾ªç¯" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.6 é¿å…æ— é™é€’å½’å¾ªç¯"><!---->4.6 é¿å…æ— é™é€’å½’å¾ªç¯<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-7-è°ƒåº¦æ‰§è¡Œ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.7 è°ƒåº¦æ‰§è¡Œ"><!---->4.7 è°ƒåº¦æ‰§è¡Œ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-8-è®¡ç®—å±æ€§-computed-ä¸-lazy" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.8 è®¡ç®—å±æ€§ computed ä¸ lazy"><!---->4.8 è®¡ç®—å±æ€§ computed ä¸ lazy<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-9-watchçš„å®ç°åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.9 watchçš„å®ç°åŸç†"><!---->4.9 watchçš„å®ç°åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-10-è¿‡æœŸçš„å‰¯ä½œç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.10 è¿‡æœŸçš„å‰¯ä½œç”¨"><!---->4.10 è¿‡æœŸçš„å‰¯ä½œç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#æœ¬ç« å®Œæ•´ä»£ç " class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æœ¬ç« å®Œæ•´ä»£ç "><!---->æœ¬ç« å®Œæ•´ä»£ç <!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li><li><!--[--><a href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%BB%93%E6%9E%84%E6%80%9D%E8%80%83%E5%8A%9B.html" class="nav-link sidebar-link sidebar-page" aria-label="ç»“æ„æ€è€ƒåŠ›"><!---->ç»“æ„æ€è€ƒåŠ›<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">è¸©å‘è®°å½•</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°</h1><div class="page-info"><span class="author-info" aria-label="AuthorğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="author-item">fyhub</span></span><span property="author" content="fyhub"></span></span><!----><span class="date-info" aria-label="Writing DateğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>February 2, 2023</span><meta property="datePublished" content="2023-02-02T09:52:47.000Z"></span><!----><!----><span class="reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 18 min</span><meta property="timeRequired" content="PT18M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">On This Page</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-1-å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" class="router-link-active router-link-exact-active toc-link level2">4.1 å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-2-å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" class="router-link-active router-link-exact-active toc-link level2">4.2 å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-3-è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ" class="router-link-active router-link-exact-active toc-link level2">4.3 è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-4-åˆ†æ”¯åˆ‡æ¢ä¸-cleanup" class="router-link-active router-link-exact-active toc-link level2">4.4 åˆ†æ”¯åˆ‡æ¢ä¸ cleanup</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-5-åµŒå¥—çš„effect-ä¸-effectæ ˆ" class="router-link-active router-link-exact-active toc-link level2">4.5 åµŒå¥—çš„effect ä¸ effectæ ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-6-é¿å…æ— é™é€’å½’å¾ªç¯" class="router-link-active router-link-exact-active toc-link level2">4.6 é¿å…æ— é™é€’å½’å¾ªç¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-7-è°ƒåº¦æ‰§è¡Œ" class="router-link-active router-link-exact-active toc-link level2">4.7 è°ƒåº¦æ‰§è¡Œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-8-è®¡ç®—å±æ€§-computed-ä¸-lazy" class="router-link-active router-link-exact-active toc-link level2">4.8 è®¡ç®—å±æ€§ computed ä¸ lazy</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-9-watchçš„å®ç°åŸç†" class="router-link-active router-link-exact-active toc-link level2">4.9 watchçš„å®ç°åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#_4-10-è¿‡æœŸçš„å‰¯ä½œç”¨" class="router-link-active router-link-exact-active toc-link level2">4.10 è¿‡æœŸçš„å‰¯ä½œç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E7%AC%AC%204%20%E7%AB%A0-%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0.html#æœ¬ç« å®Œæ•´ä»£ç " class="router-link-active router-link-exact-active toc-link level2">æœ¬ç« å®Œæ•´ä»£ç </a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="vue-js-è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°-å››-ç¬¬-4-ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°" tabindex="-1"><a class="header-anchor" href="#vue-js-è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°-å››-ç¬¬-4-ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°" aria-hidden="true">#</a> Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆå››ï¼‰ç¬¬ 4 ç« -å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°</h1><h2 id="_4-1-å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_4-1-å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" aria-hidden="true">#</a> 4.1 å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°</h2><p>å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&#39;hello vue3&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç ä¿®æ”¹äº†bodyçš„innerText, ä½†æ˜¯å…¶ä»–çš„effectä¾ç„¶å¯èƒ½ä¿®æ”¹æˆ–è·å–è¿™ä¸ª<code>innerText</code>, æ‰€ä»¥è¿™ä¸ª<code>effect</code>çš„å‡½æ•°å½±å“äº†å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œå®ƒå°±æ˜¯æœ‰å‰¯ä½œç”¨çš„ã€‚</p><p>åŒæ ·çš„ï¼Œä¾‹å¦‚ä¸‹é¢çš„val, è¢«effectå‡½æ•°ä¿®æ”¹ï¼Œä½†å®ƒæ˜¯å…¨å±€å˜é‡ï¼Œå…¶ä»–å‡½æ•°ä¹Ÿå¯èƒ½ä¼šç”¨åˆ°ï¼ŒåŒæ ·å­˜åœ¨å‰¯ä½œç”¨ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  val <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é‚£ä¹ˆä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®å‘¢ï¼Ÿ</strong></p><p>æˆ‘ä»¬å¸Œæœ›æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼Œ æ‰§è¡Œ<code>obj.text</code>èµ‹å€¼ï¼Œè‡ªåŠ¨æ‰§è¡Œeffectå‡½æ•°</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text
<span class="token punctuation">}</span>


obj<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span> <span class="token comment">// æˆ‘ä»¬å¸Œæœ›ï¼Œæ‰§è¡Œè¿™ä¸€è¡Œä¹‹åï¼Œè‡ªåŠ¨æ‰§è¡Œeffectå‡½æ•°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æˆ‘ä»¬æ¥æ¢è®¨å¦‚ä½•å®ç°å§ã€‚</p><h2 id="_4-2-å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" tabindex="-1"><a class="header-anchor" href="#_4-2-å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" aria-hidden="true">#</a> 4.2 å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°</h2><p>å¦‚ä½•å®ç°å“åº”å¼æ•°æ®å‘¢ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹</p><ul><li>å½“å‰¯ä½œç”¨å‡½æ•°<code>effect</code>æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µ <code>obj.text</code>çš„è¯»å–æ“ä½œ</li><li>å½“ä¿®æ”¹<code>obj.text</code>æ—¶ï¼Œä¼šè§¦å‘<code>obj.text</code>çš„è®¾ç½®æ“ä½œ</li></ul><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c29989e49784305961a48cc99a4df21~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy"></p><p>æˆ‘ä»¬å¯ä»¥æƒ³è±¡å‡ºä¸€ä¸ª<code>bucketï¼ˆæ¡¶ï¼‰</code>ï¼Œå½“è§¦å‘<code>è¯»å–</code>æ“ä½œæ—¶ï¼Œå°±æŠŠ<code>å‰¯ä½œç”¨effect</code>æ”¾å…¥åˆ°è¿™ä¸ª<code>æ¡¶</code>ä¸­ã€‚ å½“è§¦å‘<code>è®¾ç½®</code>æ“ä½œæ—¶ï¼Œå°±æŠŠæ¡¶ä¸­çš„<code>effect</code>æ‹¿å‡ºæ¥æ‰§è¡Œï¼Œå¯ä»¥æœ‰å¦‚ä¸‹ä»£ç </p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>
<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åŸå§‹æ•°æ®</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>
<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° effect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>
    bucket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token comment">// è¿”å›å±æ€§å€¼</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>
    bucket<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3-è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#_4-3-è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ" aria-hidden="true">#</a> 4.3 è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”å¼ç³»ç»Ÿ</h2><p>ä¸éš¾çœ‹å‡ºï¼Œå“åº”å¼ç³»ç»Ÿçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å½“å‰¯ä½œç”¨å‡½æ•°<code>effect</code>æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µ <code>obj.text</code>çš„è¯»å–æ“ä½œ</li><li>å½“ä¿®æ”¹<code>obj.text</code>æ—¶ï¼Œä¼šè§¦å‘<code>obj.text</code>çš„è®¾ç½®æ“ä½œ</li></ul><p>çœ‹ä¸Šå»ç®€å•ï¼Œä½†æ˜¯è¿˜æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠ<code>effect</code>åå­—å†™æ­»äº†ï¼Œæˆ‘ä»¬å¸Œæœ›æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
const bucket = new Set()
let activeEffect

// åŸå§‹æ•°æ®
const data = { text: &#39;hello world&#39; }
// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
const obj = new Proxy(data, {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè¯»å–æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> get(target, key) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (activeEffect) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
</span><span class="token prefix unchanged"> </span><span class="token line">       bucket.add(activeEffect)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // è¿”å›å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   return target[key]
</span><span class="token prefix unchanged"> </span><span class="token line"> },
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè®¾ç½®æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> set(target, key, newVal) {
</span><span class="token prefix unchanged"> </span><span class="token line">   // è®¾ç½®å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   target[key] = newVal
</span><span class="token prefix unchanged"> </span><span class="token line">   // æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ
</span><span class="token prefix unchanged"> </span><span class="token line">   bucket.forEach(fn =&gt; fn())
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>})


// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> function effect(fn) {
</span><span class="token prefix inserted">+</span><span class="token line">  // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix inserted">+</span><span class="token line">  activeEffect = fn
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  fn()
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†<code>effect</code>å‡½æ•°ã€‚æ”¯æŒæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªåŒ¿åå‡½æ•°</p><p>æµ‹è¯•ä»£ç ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;effect run&#39;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>text2 <span class="token operator">=</span> <span class="token string">&#39;hello vue3&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œç”±äºå‰¯ä½œç”¨å‡½æ•°å·²ç»å­˜å‚¨åˆ°äº† activeEffect ä¸­ï¼Œæ‰€ä»¥åœ¨ get æ‹¦æˆªå‡½æ•°å†…åº”è¯¥æŠŠ activeEffect æ”¶é›†åˆ°â€œæ¡¶â€ä¸­ï¼Œè¿™æ ·å“åº”ç³»ç»Ÿå°±ä¸ä¾èµ–å‰¯ä½œç”¨å‡½æ•°çš„åå­—äº†ã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬å†å¯¹è¿™ä¸ªç³»ç»Ÿç¨åŠ æµ‹è¯•ï¼Œä¾‹å¦‚åœ¨å“åº”å¼æ•°æ® obj ä¸Šè®¾ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;effect run&#39;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>notExist <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè‚¯å®šæ˜¯ä¸å¯èƒ½è§¦å‘effectå‡½æ•°çš„ï¼Œå› ä¸ºæ–°çš„å­—æ®µ<code>notExist</code>å¹¶æ²¡æœ‰è·Ÿå‰¯ä½œç”¨å‡½æ•°äº§ç”Ÿè”ç³»ã€‚</p><p><strong>é‚£ä¹ˆå¦‚ä½•å°†æƒ³è¦æ“ä½œçš„å±æ€§ï¼Œè‡ªåŠ¨ä¸effectå‡½æ•°äº§ç”Ÿè”ç³»å‘¢ï¼Ÿ</strong></p><p>ä¹‹å‰çš„Setç»“æ„è‚¯å®šä¸å¯ä»¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§æ•°æ®ç»“æ„:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>WeakMap({
    target: Map({
       key1: Set(effect1, effect2),
       key2: Set(effect1, effect2)
    }),
    target2: Map({
       key1: Set(effect1, effect2),
       key2: Set(effect1, effect2)
    }),
})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„ä»£ç :</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const bucket = new WeakMap()
</span></span>
// åŸå§‹æ•°æ®
const data = { text: &#39;hello world&#39; }
// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
const obj = new Proxy(data, {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè¯»å–æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> get(target, key) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (!activeEffect) return target[key]
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    let depsMap = bucket.get(target)
</span><span class="token prefix inserted">+</span><span class="token line">    if (!depsMap) {
</span><span class="token prefix inserted">+</span><span class="token line">      bucket.set(target, (depsMap = new Map()))
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">    let deps = depsMap.get(key)
</span><span class="token prefix inserted">+</span><span class="token line">    if (!deps) {
</span><span class="token prefix inserted">+</span><span class="token line">      depsMap.set(key, (deps = new Set()))
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">    deps.add(activeEffect)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // è¿”å›å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   return target[key]
</span><span class="token prefix unchanged"> </span><span class="token line"> },
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè®¾ç½®æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> set(target, key, newVal) {
</span><span class="token prefix unchanged"> </span><span class="token line">   // è®¾ç½®å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   target[key] = newVal
</span><span class="token prefix unchanged"> </span><span class="token line">   // æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    const depsMap = bucket.get(target)
</span><span class="token prefix inserted">+</span><span class="token line">    if (!depsMap) return
</span><span class="token prefix inserted">+</span><span class="token line">    const effects = depsMap.get(key)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   effects &amp;&amp; effects.forEach(fn =&gt; fn())
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>})


// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°
let activeEffect
function effect(fn) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix unchanged"> </span><span class="token line"> activeEffect = fn
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span><span class="token prefix unchanged"> </span><span class="token line"> fn()
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸å†å•çº¯çš„ä»<code>æ¡¶</code>ä¸­ï¼Œè·å–effectså‡½æ•°ã€‚è€Œæ˜¯å€ŸåŠ©<code>WeakMap</code>å–å‡ºtargetå¯¹è±¡ä¸‹<code>key</code>æ‰€å¯¹åº”çš„effectsã€‚</p><p>å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/65a12662c2ac474fa7e527f243e899a3~tplv-k3u1fbpfcp-watermark.image?" alt="image.png" loading="lazy"></p><p>åœ¨ç›®å‰çš„å®ç°ä¸­ï¼Œå½“è¯»å–å±æ€§å€¼æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ get æ‹¦æˆªå‡½æ•°é‡Œç¼–å†™æŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›† åˆ°â€œæ¡¶â€é‡Œçš„è¿™éƒ¨åˆ†é€»è¾‘ï¼Œä½†æ›´å¥½çš„åšæ³•æ˜¯å°†è¿™éƒ¨åˆ†é€»è¾‘å•ç‹¬å°è£…åˆ°ä¸€ä¸ª <code>track å‡½æ•°</code>ä¸­ï¼Œå‡½æ•°çš„åå­—å« track æ˜¯ä¸ºäº†è¡¨è¾¾è¿½è¸ªçš„å«ä¹‰ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œçš„é€»è¾‘å°è£…åˆ° <code>trigger å‡½æ•°</code>ä¸­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>
<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åŸå§‹æ•°æ®</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>
<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// è¿”å›å±æ€§å€¼</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span>
<span class="token keyword">let</span> activeEffect
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect</span>
  activeEffect <span class="token operator">=</span> fn
  <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// æµ‹è¯•ä»£ç </span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;effect run&#39;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&#39;text&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-4-åˆ†æ”¯åˆ‡æ¢ä¸-cleanup" tabindex="-1"><a class="header-anchor" href="#_4-4-åˆ†æ”¯åˆ‡æ¢ä¸-cleanup" aria-hidden="true">#</a> 4.4 åˆ†æ”¯åˆ‡æ¢ä¸ cleanup</h2><p>åˆ†æ”¯åˆ‡æ¢å¯èƒ½ä¼šäº§ç”Ÿé—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œ ä»¥è¿™æ®µä»£ç ä¸ºä¾‹:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">ok</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>ok <span class="token operator">?</span> obj<span class="token punctuation">.</span>text <span class="token operator">:</span> <span class="token string">&#39;not&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾<code>obj.ok</code> é»˜è®¤ä¸ºtrue, ä¾èµ–æ ‘å¦‚ä¸‹ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token literal-property property">obj</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token literal-property property">ok</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸éš¾çœ‹å‡ºï¼Œå‰¯ä½œç”¨å‡½æ•°åˆ†åˆ«è¢«<code>ok</code>å’Œ<code>text</code>ä¾èµ–æ”¶é›†ã€‚</p><p>ä½†æ˜¯å¦‚æœ<code>obj.ok</code>è¢«ä¿®æ”¹æˆ<code>false</code>, æˆ‘ä»¬<strong>æœŸæœ›çš„</strong>ä¾èµ–ç»“æ„ä¸ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token literal-property property">obj</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token literal-property property">ok</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token comment">// text: Set(effectFn)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯ï¼Œå®é™…ä¸Štextçš„ä¾èµ–ä»ç„¶å­˜åœ¨ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°<code>obj.text</code>, å¦‚æœä¿®æ”¹<code>obj.text</code>ï¼Œè¿˜æ˜¯ä¼šé‡æ–°æ‰§è¡Œeffectã€‚æ‰€ä»¥è¿™æ ·æ˜¯æœ‰é—®é¢˜çš„ï¼ æˆ‘ä»¬å¹¶ä¸å¸Œæœ›åˆ‡æ¢ä¸ºfalseçš„æ—¶å€™ï¼Œtextçš„ä¾èµ–è¿˜å­˜åœ¨ã€‚</p><p><strong>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ€è·¯å¾ˆç®€å•ï¼Œæ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ å…ˆæŠŠå®ƒä»æ‰€æœ‰ä¸ä¹‹å…³è”çš„ä¾èµ–é›†åˆä¸­åˆ é™¤</strong></p><p>ç”¨ä¸€å¼ å›¾æ¥è§£é‡Šï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3580b850b0a44a259e0bf0017f516ddb~tplv-k3u1fbpfcp-watermark.image?" alt="image.png" loading="lazy"></p><p>ç®€å•æ¥è®²ï¼Œå°±æ˜¯<code>effect</code>å’Œ<code>effect Set</code>ä¹‹é—´å»ºç«‹äº†è”ç³»ã€‚æ¯æ¬¡æ”¶é›†ä¾èµ–ä¹‹å‰ï¼Œ<strong>è·å–<code>effectFn</code>å¯¹åº”çš„ä¾èµ–é›†åˆï¼Œç„¶åæŠŠè‡ªå·±åˆ é™¤äº†ï¼Œç›¸å½“äºè§£é™¤äº†å…³è”</strong>ã€‚</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
const bucket = new WeakMap()

// åŸå§‹æ•°æ®
const data = { ok: true, text: &#39;hello world&#39; }
// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
const obj = new Proxy(data, {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè¯»å–æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> get(target, key) {
</span><span class="token prefix unchanged"> </span><span class="token line">   // å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
</span><span class="token prefix unchanged"> </span><span class="token line">   track(target, key)
</span><span class="token prefix unchanged"> </span><span class="token line">   // è¿”å›å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   return target[key]
</span><span class="token prefix unchanged"> </span><span class="token line"> },
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‹¦æˆªè®¾ç½®æ“ä½œ
</span><span class="token prefix unchanged"> </span><span class="token line"> set(target, key, newVal) {
</span><span class="token prefix unchanged"> </span><span class="token line">   // è®¾ç½®å±æ€§å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   target[key] = newVal
</span><span class="token prefix unchanged"> </span><span class="token line">   // æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ
</span><span class="token prefix unchanged"> </span><span class="token line">   trigger(target, key)
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>})

function track(target, key) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let depsMap = bucket.get(target)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!depsMap) {
</span><span class="token prefix unchanged"> </span><span class="token line">   bucket.set(target, (depsMap = new Map()))
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> let deps = depsMap.get(key)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!deps) {
</span><span class="token prefix unchanged"> </span><span class="token line">   depsMap.set(key, (deps = new Set()))
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> deps.add(activeEffect)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // effect å…³è”å±æ€§å¯¹åº”çš„ Set(effects)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  activeEffect.deps.push(deps)
</span></span>}

function trigger(target, key) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const depsMap = bucket.get(target)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!depsMap) return
</span><span class="token prefix unchanged"> </span><span class="token line"> const effects = depsMap.get(key)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> effects &amp;&amp; effects.forEach(effectFn =&gt; effectFn())
</span></span>}

// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°
let activeEffect
function effect(fn) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = () =&gt; {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   cleanup(effectFn)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectFn
</span><span class="token prefix unchanged"> </span><span class="token line">   fn()
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> // activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  effectFn.deps = []
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn()
</span></span>}

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> function cleanup(effectFn) {
</span><span class="token prefix inserted">+</span><span class="token line">   for (let i = 0; i &lt; effectFn.deps.length; i++) {
</span><span class="token prefix inserted">+</span><span class="token line">     const deps = effectFn.deps[i]
</span><span class="token prefix inserted">+</span><span class="token line">     deps.delete(effectFn)
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span><span class="token prefix inserted">+</span><span class="token line">  effectFn.deps.length = 0
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬çš„å“åº”ç³»ç»Ÿå·²ç»å¯ä»¥é¿å…å‰¯ä½œç”¨å‡½æ•°äº§ç”Ÿé—ç•™äº†ã€‚ä½†å¦‚æœä½ å°è¯•è¿è¡Œä»£ç ï¼Œä¼šå‘ç°ç›®å‰çš„å®ç°ä¼šå¯¼è‡´æ— é™å¾ªç¯æ‰§è¡Œï¼Œé—®é¢˜ å‡ºåœ¨ trigger å‡½æ•°ä¸­</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœä½ åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œæ·»åŠ å’Œåˆ é™¤Setï¼Œä¼šå¯¼è‡´æ— é™éå†:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>newSet<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  set<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// ç›¸å½“äºcleanup</span>
  set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// ç›¸å½“äºtrackæ”¶é›†ä¾èµ–</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹<code>trigger</code>å‡½æ•°</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function trigger(target, key) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const depsMap = bucket.get(target)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!depsMap) return
</span><span class="token prefix unchanged"> </span><span class="token line"> const effects = depsMap.get(key)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectsToRun = new Set()
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  effects &amp;&amp; effects.forEach(effectFn =&gt; effectsToRun.add(effectFn))
</span><span class="token prefix inserted">+</span><span class="token line">  effectsToRun.forEach(effectFn =&gt; effectFn())
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  effects &amp;&amp; effects.forEach(effectFn =&gt; effectFn())
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ–°æ„é€ äº† effectsToRun é›†åˆå¹¶éå†å®ƒï¼Œ ä»£æ›¿ç›´æ¥éå† effects é›†åˆï¼Œä»è€Œé¿å…äº†æ— é™æ‰§è¡Œã€‚</p><h2 id="_4-5-åµŒå¥—çš„effect-ä¸-effectæ ˆ" tabindex="-1"><a class="header-anchor" href="#_4-5-åµŒå¥—çš„effect-ä¸-effectæ ˆ" aria-hidden="true">#</a> 4.5 åµŒå¥—çš„effect ä¸ effectæ ˆ</h2><p>æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ä¸‹é¢çš„ä»£ç ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;effectFn1 æ‰§è¡Œ&#39;</span><span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;effectFn2 æ‰§è¡Œ&#39;</span><span class="token punctuation">)</span>
    temp2 <span class="token operator">=</span> obj<span class="token punctuation">.</span>bar
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  temp1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨åˆå§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè‡ªç„¶ä¼šè§¦å‘<code>effectFn1</code>å’Œ<code>effectFn2</code>ï¼Œä½†æ˜¯å½“ä½ ä¿®æ”¹<code>obj.foo</code>çš„æ—¶å€™ï¼Œå´åªä¼šæ‰§è¡Œ<code>effectFn2</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åœ¨å‰é¢ï¼Œæˆ‘ä»¬æ˜¯ç”¨è¿‡è¿™æ ·çš„æ–¹å¼è·å–<code>effect</code>çš„ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>activeEffect <span class="token operator">=</span> effectFn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åˆæ¬¡æ‰§è¡Œå®Œåï¼Œæœ€åä¸€æ¬¡æ‰§è¡Œåï¼Œ<code>activeEffect === effectFn2</code>, æ­¤æ—¶<code>obj.foo</code>æ”¶é›†çš„å…¶å®æ˜¯<code>effectFn2</code>ã€‚</p><p>é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªæ ˆçš„ç»“æ„, ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°
let activeEffect
// effect æ ˆ
const effectStack = []

function effect(fn) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   cleanup(effectFn)
</span><span class="token prefix unchanged"> </span><span class="token line">   // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectFn
</span><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    effectStack.push(effectFn)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   fn()
</span><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸ activeEffect ä¸ºä¹‹å‰çš„å€¼
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    effectStack.pop()
</span><span class="token prefix inserted">+</span><span class="token line">    activeEffect = effectStack[effectStack.length - 1]
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> // activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn.deps = []
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn()
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-6-é¿å…æ— é™é€’å½’å¾ªç¯" tabindex="-1"><a class="header-anchor" href="#_4-6-é¿å…æ— é™é€’å½’å¾ªç¯" aria-hidden="true">#</a> 4.6 é¿å…æ— é™é€’å½’å¾ªç¯</h2><p>æ€è€ƒå¦‚ä¸‹ä»£ç ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åä¼šå¯¼è‡´æ— é™é€’å½’ã€‚</p><p>åœ¨è¿™ä¸ªè¯­å¥ä¸­ï¼Œæ—¢ä¼šè¯»å– obj.foo çš„å€¼ï¼Œåˆä¼šè®¾ç½® obj.foo çš„ å€¼ï¼Œè€Œè¿™å°±æ˜¯å¯¼è‡´é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚</p><p>åŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ trigger åŠ¨ä½œå‘ç”Ÿæ—¶å¢åŠ å®ˆå«æ¡ä»¶ï¼š<strong>å¦‚æœ trigger è§¦å‘æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸è§¦å‘æ‰§è¡Œ</strong></p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function trigger(target, key) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const depsMap = bucket.get(target)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!depsMap) return
</span><span class="token prefix unchanged"> </span><span class="token line"> const effects = depsMap.get(key)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectsToRun = new Set()
</span><span class="token prefix unchanged"> </span><span class="token line"> effects &amp;&amp; effects.forEach(effectFn =&gt; {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (effectFn !== activeEffect) {
</span><span class="token prefix inserted">+</span><span class="token line">      effectsToRun.add(effectFn)
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> })
</span><span class="token prefix unchanged"> </span><span class="token line"> effectsToRun.forEach(effectFn =&gt; effectFn())
</span><span class="token prefix unchanged"> </span><span class="token line"> // effects &amp;&amp; effects.forEach(effectFn =&gt; effectFn())
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-7-è°ƒåº¦æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_4-7-è°ƒåº¦æ‰§è¡Œ" aria-hidden="true">#</a> 4.7 è°ƒåº¦æ‰§è¡Œ</h2><p>æ€è€ƒä¸‹é¢çš„ä»£ç ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»“æŸäº†&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­£å¸¸æ¥è®²ï¼Œä¼šæ‰“å°å¦‚ä¸‹å†…å®¹ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token number">1</span>
<span class="token number">2</span>
ç»“æŸäº†
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬æƒ³å®ç°ï¼Œè¿™æ ·çš„è¾“å‡ºå‘¢ï¼Ÿ</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token number">1</span>
ç»“æŸäº†
<span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å¯èƒ½ä¼šæƒ³åˆ°æŠŠ<code>console.log</code>æ”¾åˆ°ä¸Šé¢ã€‚ä½†æœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿ</p><p>å…¶å®æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªé€‰é¡¹å‚æ•°ï¼Œå…è®¸æŒ‡å®šè°ƒåº¦å™¨</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹<code>effect</code>å‡½æ•°çš„å®ç°ï¼š</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function effect(fn, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   cleanup(effectFn)
</span><span class="token prefix unchanged"> </span><span class="token line">   // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectFn
</span><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ
</span><span class="token prefix unchanged"> </span><span class="token line">   effectStack.push(effectFn)
</span><span class="token prefix unchanged"> </span><span class="token line">   fn()
</span><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸ activeEffect ä¸ºä¹‹å‰çš„å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   effectStack.pop()
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectStack[effectStack.length - 1]
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> // å°† options æŒ‚åœ¨åˆ° effectFn ä¸Š
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  effectFn.options = options
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn.deps = []
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn()
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿®æ”¹ä¸€ä¸‹<code>trigger</code>å‡½æ•°:</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function trigger(target, key) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const depsMap = bucket.get(target)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!depsMap) return
</span><span class="token prefix unchanged"> </span><span class="token line"> const effects = depsMap.get(key)
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectsToRun = new Set()
</span><span class="token prefix unchanged"> </span><span class="token line"> effects &amp;&amp; effects.forEach(effectFn =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   if (effectFn !== activeEffect) {
</span><span class="token prefix unchanged"> </span><span class="token line">     effectsToRun.add(effectFn)
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> })
</span><span class="token prefix unchanged"> </span><span class="token line"> effectsToRun.forEach(effectFn =&gt; {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (effectFn.options.scheduler) {
</span><span class="token prefix inserted">+</span><span class="token line">      effectFn.options.scheduler(effectFn)
</span><span class="token prefix inserted">+</span><span class="token line">    } else {
</span><span class="token prefix inserted">+</span><span class="token line">      effectFn()
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> })
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰äº†ä¸Šé¢çš„ä»£ç å®ç°ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„ä¾‹å­</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»“æŸäº†&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åå°±èƒ½æ‰“å°å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>1
ç»“æŸäº†
2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>åˆ†å‰²ä¸€ä¸‹====</p><p>å¤§å®¶å†æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>
obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¼šæ‰“å°ä¸‰æ¬¡:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>1
2
3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä¸æƒ³å…³å¿ƒä¸­é—´çš„çŠ¶æ€ï¼Œåªéœ€è¦æœ€å¼€å§‹å’Œæœ€åçš„çŠ¶æ€ï¼Œå¦‚æœç”¨è°ƒåº¦å™¨å®ç°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>
<span class="token comment">// =====================</span>
<span class="token comment">// ä»£ç å®ç°</span>
<span class="token keyword">const</span> jobQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// ä¸€ä¸ªæ ‡å¿—ä»£è¡¨æ˜¯å¦æ­£åœ¨åˆ·æ–°é˜Ÿåˆ—</span>
<span class="token keyword">let</span> isFlushing <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">function</span> <span class="token function">flushJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœé˜Ÿåˆ—æ­£åœ¨åˆ·æ–°ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlushing<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// è®¾ç½®ä¸º trueï¼Œä»£è¡¨æ­£åœ¨åˆ·æ–°</span>
  isFlushing <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­åˆ·æ–° jobQueue é˜Ÿåˆ—</span>
  p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jobQueue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">job</span> <span class="token operator">=&gt;</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    isFlushing <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// =====================</span>

<span class="token comment">// ç¤ºä¾‹ä»£ç </span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jobQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token function">flushJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>
obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-8-è®¡ç®—å±æ€§-computed-ä¸-lazy" tabindex="-1"><a class="header-anchor" href="#_4-8-è®¡ç®—å±æ€§-computed-ä¸-lazy" aria-hidden="true">#</a> 4.8 è®¡ç®—å±æ€§ computed ä¸ lazy</h2><p>computedçš„æ ¸å¿ƒåœ¨äºè¿™å‡ ç‚¹:</p><ul><li><strong>lazy å¯é€šè¿‡optionsè®¾ç½®ï¼Œå½“å®ƒä¸ºtrueæ—¶ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</strong></li><li><strong>å‰¯ä½œç”¨å‡½æ•°å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ï¼Œgetterå¯ä»¥è¿”å›å€¼</strong></li><li><strong>å¯¹äºè®¡ç®—å±æ€§çš„effectå‡½æ•°æ¥è¯´ï¼Œå®ƒå†…éƒ¨çš„å“åº”å¼æ•°æ®æ”¶é›†çš„ä¼šæ˜¯è®¡ç®—å±æ€§çš„effect</strong></li><li><strong>è®¡ç®—å±æ€§çš„getå’Œsetæ²¡æœ‰trackå’Œtriggerï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨</strong></li><li><strong>å½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œdirtyè®¾ç½®ä¸ºtrue</strong></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value
  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token function">track</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function effect(fn, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   cleanup(effectFn)
</span><span class="token prefix unchanged"> </span><span class="token line">   // å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectFn
</span><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ
</span><span class="token prefix unchanged"> </span><span class="token line">   effectStack.push(effectFn)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    const res = fn()
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸ activeEffect ä¸ºä¹‹å‰çš„å€¼
</span><span class="token prefix unchanged"> </span><span class="token line">   effectStack.pop()
</span><span class="token prefix unchanged"> </span><span class="token line">   activeEffect = effectStack[effectStack.length - 1]
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    return res
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> // å°† options æŒ‚åœ¨åˆ° effectFn ä¸Š
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn.options = options
</span><span class="token prefix unchanged"> </span><span class="token line"> // activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ
</span><span class="token prefix unchanged"> </span><span class="token line"> effectFn.deps = []
</span><span class="token prefix unchanged"> </span><span class="token line"> // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if (!options.lazy) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   effectFn()
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  return effectFn
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ¥å¤§è‡´èµ°ä¸€ä¸‹æµç¨‹ï¼š</p><ul><li><p>åˆ›å»ºè®¡ç®—å±æ€§</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sumRes <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo <span class="token operator">+</span> obj<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è®¡ç®—å±æ€§<code>effect</code>å‡½æ•°ä¼šè¢«åˆ›å»ºï¼Œå¹¶ä¸”lazy ä¸ä¼šç«‹åˆ»æ‰§è¡Œ</p></li><li><p>è®¿é—®è®¡ç®—å±æ€§</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sumRes<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>åˆšå¼€å§‹dirtyä¸ºtrue, ä¼šè°ƒç”¨è®¡ç®—å±æ€§çš„effectå‡½æ•°ï¼Œè®¡ç®—sumResï¼Œdirtyä¸ºfalse.</li><li>åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œä¼šè§¦å‘<code>obj.foo</code>å’Œ<code>obj.bar</code>çš„ä¾èµ–æ”¶é›†ï¼Œå®ƒä»¬ä¼šæ”¶é›†è®¡ç®—å±æ€§çš„effectå‡½æ•°</li><li>è®¡ç®—å®Œæˆåï¼Œæ‰‹åŠ¨è°ƒç”¨<code>track</code>ï¼Œè®©è®¡ç®—å±æ€§æ”¶é›†ä¸€ä¸‹è‡ªå·±getterçš„effectå‡½æ•°</li></ol></li><li><p>ä¿®æ”¹å“åº”å¼å˜é‡</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>obj<span class="token punctuation">.</span>foo <span class="token operator">++</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è§¦å‘getæ–¹æ³•ï¼Œä¼šæ‰§è¡Œ<code>scheduler</code>æ–¹æ³•ï¼Œåˆ¤æ–­<code>dirty === false</code>, è®¾ç½®<code>dirty = true</code>, ç„¶åæ‰§è¡Œä¹‹å‰è®¡ç®—å±æ€§è‡ªå·±æ”¶é›†çš„getterå‰¯ä½œç”¨å‡½æ•°, æœ€åé‡æ–°è®¡ç®—æ–°å€¼ã€‚</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scheduler() {
    if (!dirty) {
      dirty = true
      trigger(obj, &#39;value&#39;)
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="_4-9-watchçš„å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#_4-9-watchçš„å®ç°åŸç†" aria-hidden="true">#</a> 4.9 watchçš„å®ç°åŸç†</h2><p><strong>watch çš„å®ç°æœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨äº† effect ä»¥åŠ options.scheduler é€‰é¡¹</strong></p><p>æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªæœ€ç®€å•çš„watch</p><p>ä¾‹å­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°ä»£ç </p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> source
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> oldValue<span class="token punctuation">,</span> newValue

  <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    newValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
    oldValue <span class="token operator">=</span> newValue
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  oldValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç éš¾åº¦ä¸å¤§ï¼š</p><ol><li><p>ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„getter,ä½œä¸ºeffectå‡½æ•°çš„getter</p></li><li><p>æˆ‘ä»¬è®¾ç½®äº†<code>lazy</code>ä¸ºtrue, ä¸ä¼šç«‹å³æ‰§è¡Œã€‚</p><p>ç„¶åå®ç°äº†<code>scheduler</code>è°ƒåº¦å™¨ï¼Œä¼šæ‰§è¡Œæˆ‘ä»¬çš„å›è°ƒå‡½æ•°ã€‚</p></li><li><p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå…ˆè°ƒç”¨getterç¼“å­˜ä¸€ä¸‹æœ€æ–°çš„å€¼ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨åˆæ¬¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œå°±èƒ½æ‹¿åˆ°æ—§çš„å€¼äº†ã€‚</p></li></ol><hr><p>ä¸Šé¢åªå®ç°äº†æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œå…¶å®<code>watch</code>è¿˜æ”¯æŒç«‹å³æ‰§è¡Œï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// ç«‹å³æ‰§è¡Œ</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å®ç°ä»£ç ï¼š</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function watch(source, cb, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let getter
</span><span class="token prefix unchanged"> </span><span class="token line"> if (typeof source === &#39;function&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = source
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let oldValue, newValue
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const job = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   newValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line">   cb(oldValue, newValue)
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = newValue
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = effect(
</span><span class="token prefix unchanged"> </span><span class="token line">   // æ‰§è¡Œ getter
</span><span class="token prefix unchanged"> </span><span class="token line">   () =&gt; getter(),
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">     lazy: true,
</span><span class="token prefix unchanged"> </span><span class="token line">     scheduler: () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       job()
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> )
</span><span class="token prefix unchanged"> </span><span class="token line"> 
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if (options.immediate) {
</span><span class="token prefix inserted">+</span><span class="token line">    job()
</span><span class="token prefix inserted">+</span><span class="token line">  } else {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   oldValue = effectFn()
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·å°±å¯ä»¥åœ¨watchåˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€éå›è°ƒäº†ã€‚</p><hr><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>watch</code>è¿˜æ”¯æŒå¼‚æ­¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">&#39;post&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°èµ·æ¥åŒæ ·ç®€å•ï¼š</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function watch(source, cb, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let getter
</span><span class="token prefix unchanged"> </span><span class="token line"> if (typeof source === &#39;function&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = source
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = () =&gt; traverse(source)
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let oldValue, newValue
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const job = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   newValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line">   cb(oldValue, newValue)
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = newValue
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = effect(
</span><span class="token prefix unchanged"> </span><span class="token line">   // æ‰§è¡Œ getter
</span><span class="token prefix unchanged"> </span><span class="token line">   () =&gt; getter(),
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">     lazy: true,
</span><span class="token prefix unchanged"> </span><span class="token line">     scheduler: () =&gt; {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        if (options.flush === &#39;post&#39;) {
</span><span class="token prefix inserted">+</span><span class="token line">          const p = Promise.resolve()
</span><span class="token prefix inserted">+</span><span class="token line">          p.then(job)
</span><span class="token prefix inserted">+</span><span class="token line">        } else {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">         job()
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> )
</span><span class="token prefix unchanged"> </span><span class="token line"> 
</span><span class="token prefix unchanged"> </span><span class="token line"> if (options.immediate) {
</span><span class="token prefix unchanged"> </span><span class="token line">   job()
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>å¤§å®¶å¯èƒ½å‘ç°ï¼Œgetterçš„å†™æ³•éƒ½æ˜¯å‡½æ•°çš„å†™æ³•ï¼Œ<code>watch</code>åº”è¯¥ä¹Ÿæ”¯æŒç›´æ¥è§‚å¯Ÿå¯¹è±¡çš„å˜åŒ–</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span>obj <span class="token comment">/*æ­¤å¤„*/</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">&#39;post&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹è·å–<code>getter</code>çš„åœ°æ–¹ï¼š</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">function traverse(value, seen = new Set()) {
</span><span class="token prefix inserted">+</span><span class="token line">  if (typeof value !== &#39;object&#39; || value === null || seen.has(value)) return
</span><span class="token prefix inserted">+</span><span class="token line">  seen.add(value)
</span><span class="token prefix inserted">+</span><span class="token line">  for (const k in value) {
</span><span class="token prefix inserted">+</span><span class="token line">    traverse(value[k], seen)
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span><span class="token prefix inserted">+</span><span class="token line">  return value
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>
function watch(source, cb, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let getter
</span><span class="token prefix unchanged"> </span><span class="token line"> if (typeof source === &#39;function&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = source
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  } else {
</span><span class="token prefix inserted">+</span><span class="token line">    getter = () =&gt; traverse(source)
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let oldValue, newValue
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const job = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   newValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line">   cb(oldValue, newValue)
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = newValue
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = effect(
</span><span class="token prefix unchanged"> </span><span class="token line">   // æ‰§è¡Œ getter
</span><span class="token prefix unchanged"> </span><span class="token line">   () =&gt; getter(),
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">     lazy: true,
</span><span class="token prefix unchanged"> </span><span class="token line">     scheduler: () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       if (options.flush === &#39;post&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">         const p = Promise.resolve()
</span><span class="token prefix unchanged"> </span><span class="token line">         p.then(job)
</span><span class="token prefix unchanged"> </span><span class="token line">       } else {
</span><span class="token prefix unchanged"> </span><span class="token line">         job()
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> )
</span><span class="token prefix unchanged"> </span><span class="token line"> 
</span><span class="token prefix unchanged"> </span><span class="token line"> if (options.immediate) {
</span><span class="token prefix unchanged"> </span><span class="token line">   job()
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸éš¾çœ‹å‡ºï¼Œ<code>traverse</code>ä¼šé€’å½’éå†å¯¹è±¡ä¸‹æ‰€æœ‰çš„å±æ€§ã€‚</p><p><strong>æ‰€ä»¥æ¨èå¤§å®¶ä½¿ç”¨<code>watch</code>çš„æ—¶å€™ï¼Œgetterä½¿ç”¨å‡½æ•°çš„å†™æ³•ï¼Œå¯ä»¥ç²¾ç¡®åˆ°å…·ä½“çš„å±æ€§ï¼</strong></p><h2 id="_4-10-è¿‡æœŸçš„å‰¯ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#_4-10-è¿‡æœŸçš„å‰¯ä½œç”¨" aria-hidden="true">#</a> 4.10 è¿‡æœŸçš„å‰¯ä½œç”¨</h2><p>æˆ‘ä»¬æœ‰æ—¶ä¼šé‡åˆ°å¦‚ä¸‹åœºæ™¯ï¼ŒåŒæ ·çš„æ¥å£å…ˆåè°ƒç”¨äº†ä¸¤æ¬¡</p><ul><li>å‘é€è¯·æ±‚A</li><li>å‘é€è¯·æ±‚B</li></ul><p>æˆ‘ä»¬æœŸæœ›çš„æ˜¯æœ€ç»ˆè·å–åˆ°çš„æ˜¯B, ä½†æ˜¯å¦‚æœBæ¥å£æ¯”è¾ƒæ…¢ï¼Œä¼šå¯¼è‡´Açš„ç»“æœè¦†ç›–Bã€‚</p><p>å…¶å®è¿™ç§é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>watch</code>çš„<code>onInvalidate</code>æ¥è§£å†³ã€‚</p><p><code>onInvalidate</code>æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šé‡æ–°è¯·æ±‚æ¥å£ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  finallyData <span class="token operator">=</span> res
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>finallyData<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆæ˜æ˜¾ï¼Œä¼šå¯¼è‡´å‡ºç°ä¸Šé¢çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> expired <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    expired <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expired<span class="token punctuation">)</span> <span class="token keyword">return</span>

  finallyData <span class="token operator">=</span> res
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>finallyData<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å®šä¹‰äº† expired æ ‡å¿— å˜é‡ï¼Œç”¨æ¥æ ‡è¯†å½“å‰å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ˜¯å¦è¿‡æœŸï¼›æ¥ç€è°ƒç”¨ onInvalidate å‡½æ•°æ³¨å†Œäº†ä¸€ä¸ªè¿‡æœŸå›è°ƒï¼Œå½“è¯¥å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œè¿‡ æœŸæ—¶å°† expired æ ‡å¿—å˜é‡è®¾ç½®ä¸º trueï¼›æœ€ååªæœ‰å½“æ²¡æœ‰è¿‡æœŸæ—¶æ‰é‡‡ç”¨è¯·æ±‚ç»“æœï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸Šè¿°é—®é¢˜äº†ã€‚</p><p>onInvalidate çš„åŸç† æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåœ¨ watch å†…éƒ¨æ¯æ¬¡æ£€æµ‹åˆ°å˜æ›´åï¼Œåœ¨å‰¯ä½œç”¨ å‡½æ•°é‡æ–°æ‰§è¡Œä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨æˆ‘ä»¬é€šè¿‡ onInvalidate å‡½æ•°æ³¨å†Œçš„è¿‡ æœŸå›è°ƒï¼Œä»…æ­¤è€Œå·²</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>function watch(source, cb, options = {}) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let getter
</span><span class="token prefix unchanged"> </span><span class="token line"> if (typeof source === &#39;function&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = source
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   getter = () =&gt; traverse(source)
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let oldValue, newValue
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  let cleanup
</span><span class="token prefix inserted">+</span><span class="token line">  function onInvalidate(fn) {
</span><span class="token prefix inserted">+</span><span class="token line">    cleanup = fn
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const job = () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   newValue = effectFn()
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (cleanup) {
</span><span class="token prefix inserted">+</span><span class="token line">      cleanup()
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    cb(oldValue, newValue)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    cb(oldValue, newValue, onInvalidate)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   oldValue = newValue
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const effectFn = effect(
</span><span class="token prefix unchanged"> </span><span class="token line">   // æ‰§è¡Œ getter
</span><span class="token prefix unchanged"> </span><span class="token line">   () =&gt; getter(),
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">     lazy: true,
</span><span class="token prefix unchanged"> </span><span class="token line">     scheduler: () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       if (options.flush === &#39;post&#39;) {
</span><span class="token prefix unchanged"> </span><span class="token line">         const p = Promise.resolve()
</span><span class="token prefix unchanged"> </span><span class="token line">         p.then(job)
</span><span class="token prefix unchanged"> </span><span class="token line">       } else {
</span><span class="token prefix unchanged"> </span><span class="token line">         job()
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> )
</span><span class="token prefix unchanged"> </span><span class="token line"> 
</span><span class="token prefix unchanged"> </span><span class="token line"> if (options.immediate) {
</span><span class="token prefix unchanged"> </span><span class="token line">   job()
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   oldValue = effectFn()
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æœ¬ç« å®Œæ•´ä»£ç " tabindex="-1"><a class="header-anchor" href="#æœ¬ç« å®Œæ•´ä»£ç " aria-hidden="true">#</a> æœ¬ç« å®Œæ•´ä»£ç </h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>
<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åŸå§‹æ•°æ®</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// è¿”å›å±æ€§å€¼</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

  <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// effects &amp;&amp; effects.forEach(effectFn =&gt; effectFn())</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span>
<span class="token keyword">let</span> activeEffect
<span class="token comment">// effect æ ˆ</span>
<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
    <span class="token comment">// å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect</span>
    activeEffect <span class="token operator">=</span> effectFn
    <span class="token comment">// åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ</span>
    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸ activeEffect ä¸ºä¹‹å‰çš„å€¼</span>
    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
  <span class="token comment">// å°† options æŒ‚åœ¨åˆ° effectFn ä¸Š</span>
  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token comment">// activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ</span>
  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> effectFn
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    deps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// =========================</span>

<span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value
  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token function">track</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>


<span class="token comment">// =========================</span>

<span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> value <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> source
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> oldValue<span class="token punctuation">,</span> newValue

  <span class="token keyword">let</span> cleanup
  <span class="token keyword">function</span> <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cleanup <span class="token operator">=</span> fn
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    newValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> onInvalidate<span class="token punctuation">)</span>
    oldValue <span class="token operator">=</span> newValue
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token comment">// æ‰§è¡Œ getter</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>flush <span class="token operator">===</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    oldValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">Last update: </span><!----></div><div class="meta-item contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: fanyihui@tuhu.cn">1131153523@qq.com</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/informal/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/Vue.js%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E7%AC%AC%202%20%E7%AB%A0-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%A0%B8%E5%BF%83%E8%A6%81%E7%B4%A0.html" class="nav-link prev" aria-label="Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆäºŒï¼‰ç¬¬ 2 ç« -æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒè¦ç´ "><div class="hint"><span class="arrow left"></span>Prev</div><div class="link"><!---->Vue.js è®¾è®¡ä¸å®ç°é˜…è¯»ç¬”è®°ï¼ˆäºŒï¼‰ç¬¬ 2 ç« -æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒè¦ç´ </div></a><!----></nav><div class="giscus-wrapper" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.c4c36fb7.js" defer></script>
  </body>
</html>
