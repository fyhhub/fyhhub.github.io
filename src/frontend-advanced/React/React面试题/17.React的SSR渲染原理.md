---
order: 17
---
# 17.React的SSR渲染原理

SSR（Server-Side Rendering，服务端渲染）

同构则是指，**在服务端和客户端使用同一套代码（或者尽可能相同的代码）来生成和渲染HTML**。


React 在进行服务端渲染时，会在根节点上添加一个名为 `data-reactroot` 的属性，用于标识该节点是 React 渲染出来的根节点。

**当 React 在浏览器端执行时，会通过 document.querySelector('[data-reactroot]') 方法来获取根节点。如果能够找到这个节点，就表示该节点是由服务端渲染出来的，此时 React 会对该节点进行“混合”，将服务端渲染的内容与客户端渲染的内容进行合并。如果找不到这个节点，就表示该页面没有进行过服务端渲染，此时 React 就会直接使用客户端渲染的方式进行渲染。**



### 一问：为什么还要再客户端执行一遍js代码？

主要有以下几个原因：
1. 服务端执行渲染的时候，产生的html并没有绑定事件，需要在客户端执行一遍，进而绑定事件
2. 有些动态数据，例如列表页面，需要通过请求获取数据，然后动态添加到列表最后。
3. 服务端无法访问浏览器的API, 例如localstorage, document等。


### 二问：react ssr 哪个方法可以实现客户端渲染和服务端的渲染

服务端
```js
 ReactDOM.renderToString(<MyComponent />);
```

客户端
```js
ReactDOM.hydrate(<MyComponent />, document.getElementById('root'));
```

### 三问：ReactDOM.hydrate 和 ReactDOM.render有什么区别呢

1. **是否需要复用已存在的DOM节点**

  每次调用 `ReactDOM.render()` 方法时，都会创建新的DOM节点，并且之前渲染的DOM节点将被删除。

  `ReactDOM.hydrate()` 方法会将组件渲染到已经存在的DOM节点上，并尝试复用之前的DOM节点。这样可以避免不必要的DOM操作和重新渲染，提高页面性能和渲染速度。

2. **是否处理事件绑定和其他副作用**
`ReactDOM.hydrate()` 方法还会尝试恢复组件在服务端渲染时所绑定的事件处理程序和其他副作用。这样可以确保在浏览器中渲染出的组件与在服务端渲染出的组件在行为和交互上保持一致。



### 四问：如何判断节点可以复用

1. 判断VNode的tag 和 DOM的tag是否相同，如果不相同不能复用
2. 判断key是否相同，否则不能复用
3. 判断此次渲染是否被捕获，比如这个节点是`Suspense`组件，这个组件会抛出一个`Promise`， 如果这个组件已经被捕获，节点无法被复用，否则可以复用。

  这里的“捕获”指的是将 Suspense 组件抛出的 Promise 记录在 React 内部的状态中，以便在后续的渲染过程中进行处理。当 Promise resolve 之后，React 会将其作为可用数据，然后继续进行渲染。在客户端渲染过程中，React 会检查每个 Suspense 组件是否已经在本次渲染中被捕获，以便正确地复用节点。
